# MiniScheditor — 基于 Avalonia 的原理图编辑器演示

[English](README.md)

![Screen shot](Assets/screenshot.png)


MiniScheditor 是一个基于 .NET + Avalonia 的小型演示程序，用于探索构建交互式电子原理图（电路图）编辑器时常用的算法和技术。它侧重于简洁且高质量的绘图画布、有效的空间索引、吸附与布线行为以及可扩展的符号库。该项目保持精简，用作 UI/UX 与几何处理技巧的练习平台。

---

## 主要功能

- 交互式画布：支持平移、缩放与吸附
- 正交布线：支持「点-点」布线并可以吸附到引脚
- 元件放置：带符号预览与网格吸附
- 可视化选择与拖拽元件
- 使用 QuadTree 进行高效的空间查询以加速渲染和命中检测
- 简单的符号库示例：电阻、电容、二极管、NPN 三极管

---

## 代码中重要位置

- `Controls/SchematicCanvas.cs` — UI 与交互核心：绘制、输入处理、选择、平移、缩放与布线、命中检测等。
- `Models/SchematicElements.cs` — 域模型：Component（元件）、Wire（连线）、Junction（交点）、Document、Layer
- `Models/Symbols.cs` — 内置符号库（电阻、电容、二极管、NPN）与绘制原语
- `Models/EditTool.cs` — 编辑工具（选择、布线、元件放置）及扩展模式
- `Core/QuadTree.cs` — 空间索引用于高效查询与渲染
- `Views/MainWindow.axaml` + `Program.cs` — 应用入口与窗口关联（Avalonia）

---

## 坐标系 / 单位 与 网格

MiniScheditor 使用基于整数的世界坐标系，其中 1 单位等于 100,000 nm = 0.1 mm。采用整数坐标可以在对象边界上减少部分浮点误差并实现细粒度几何。基础网格使用 1.27 mm 间隔（1270000 世界单位），这是印刷电路与原理图工具常见的网格间距。符号坐标以较小的逻辑单位编写，在渲染时进行缩放。

---

## 操作说明 / 控件

在运行程序（桌面）时：

- 左键单击：依据当前工具选择对象或放置元件
- 点-点布线：选择 Wire 工具，首次点击开始布线，再次点击结束一个正交线段。系统会吸附到元件引脚或临近连线点。
- 中键按住并拖拽：平移画布
- 滚轮：围绕鼠标位置缩放视图
- ESC：取消当前操作（布线、选择框、拖拽等）
- Delete：删除已选对象

工具由 `EditTool` 的子类实现；画布根据当前激活的工具做出不同响应。

---

## 实现原理（简要）

- 渲染：`SchematicCanvas.Render` 负责绘制网格、页边框、原点十字、可见对象以及预览元素。可见对象通过向 QuadTree 查询当前可视范围获得。
- 空间索引：`QuadTree<T>` 保存对象边界以便高效的可见性判断和命中检测，从而在文档较大时仍能保持交互和渲染性能。
- 命中检测 / 吸附：鼠标位置通过画布的 scale/offset 在屏幕坐标与世界坐标之间转换。吸附策略按顺序尝试：先引脚 → 再连线 → 最后网格，从而提供直观的编辑体验。
- 布线与交点逻辑：布线时会检测是否需要创建交点（例如连线相交或有 ≥3 个端点），并可添加 `Junction` 对象。

---

## 限制 / 待办（代码观察）

- QuadTree 当前对元件移动的处理不够完善：代码里有注释提到移动元件时没有更新 QuadTree（采用了简单方式）。生产级编辑器应在移动时将对象从树中移除并重新插入，或使用支持动态更新的空间索引结构。
- 未实现持久化（缺少保存/加载）——此项目主要用于交互原型演示。
- 选择和重叠规则在演示中较为简单；真实编辑器需处理更多边界情况（绘制次序、 多图层规则、复杂选择策略等）。

---

## 构建与运行（跨平台）

前提：
- 安装 .NET SDK（示例项目使用 net10.0）

在仓库根目录中通过终端构建并运行：

```pwsh
dotnet restore
dotnet build -c Debug
dotnet run --project MiniScheditor.csproj
```

首次运行应打开一个桌面窗口，显示空白的原理图画布。使用界面中的工具来放置元件、布线、平移与缩放等操作。

---

## 可扩展方向（建议）

- 增加持久化：支持将文档保存/加载为 JSON、XML 或自定义格式
- 实现撤销/重做（undo/redo）机制
- 改进 QuadTree（或换用支持动态更新的数据结构）以在移动对象时正确更新索引
- 增强吸附功能（45° 吸附、多级网格、元件旋转与锚点）
- 添加更多符号并实现符号编辑器以便用户编写新元件
- 支持电气网表（netlist）跟踪、连通性验证和与仿真工具的集成

---

## 授权

用于教学和视频演示。

公共领域 (无使用限制).

作者：李维 (email: oldrev@gmail.com) （其实主要是 Copilot）